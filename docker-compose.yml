version: '3.8'

services:
  # MariaDB Database
  db:
    image: mariadb:10.11
    container_name: foodcourt_db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD:-P@ssw0rd@dev}
      MYSQL_DATABASE: ${DB_NAME:-maket_place_system}
      MYSQL_USER: ${DB_USER:-foodcourt_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-foodcourt_pass}
      TZ: Asia/Bangkok
    volumes:
      - db_data:/var/lib/mysql
      - ./scripts/init_db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    ports:
      - "${DB_PORT:-3306}:3306"
    networks:
      - foodcourt_network
    healthcheck:
      test: CMD sh -c "mysqladmin ping -h localhost -u root -p\"$$MYSQL_ROOT_PASSWORD\""
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # FastAPI Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: foodcourt_app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Database
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-maket_place_system}
      DB_USER: ${DB_USER:-foodcourt_user}
      DB_PASSWORD: ${DB_PASSWORD:-foodcourt_pass}
      
      # Backend
      BACKEND_URL: ${BACKEND_URL:-http://150.95.85.185}
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      DEBUG: ${DEBUG:-false}
      ENABLE_DOCS: ${ENABLE_DOCS:-false}
      
      # CORS
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-*}
      
      # E-Money
      HAS_E_MONEY_LICENSE: ${HAS_E_MONEY_LICENSE:-false}
      AUTO_REFUND_ENABLED: ${AUTO_REFUND_ENABLED:-true}
      REFUND_NOTIFICATION_TIME: ${REFUND_NOTIFICATION_TIME:-23:00}
      DAILY_BALANCE_RESET: ${DAILY_BALANCE_RESET:-true}
      
      # Crypto
      BLOCKCHAIN_EXPLORER_API: ${BLOCKCHAIN_EXPLORER_API:-https://api.blockchain.info}
      TRANSACTION_FEE: ${TRANSACTION_FEE:-5.00}
      MONTHLY_FLAT_FEE: ${MONTHLY_FLAT_FEE:-500.00}
      CRYPTO_ENABLED: ${CRYPTO_ENABLED:-true}
      
      # Tax
      WHT_RATE: ${WHT_RATE:-0.03}
      VAT_RATE: ${VAT_RATE:-0.07}
      TAX_ID: ${TAX_ID:-}
      COMPANY_NAME: ${COMPANY_NAME:-}
      
      # Payment
      PROMPTPAY_ENABLED: ${PROMPTPAY_ENABLED:-true}
      PROMPTPAY_API_URL: ${PROMPTPAY_API_URL:-}
      
      # Notification
      LINE_OA_CHANNEL_ACCESS_TOKEN: ${LINE_OA_CHANNEL_ACCESS_TOKEN:-}
      LINE_OA_CHANNEL_SECRET: ${LINE_OA_CHANNEL_SECRET:-}
      PUSH_NOTIFICATION_ENABLED: ${PUSH_NOTIFICATION_ENABLED:-true}
      
      TZ: Asia/Bangkok
    volumes:
      - ./config.ini:/app/config.ini:ro
      - ./app/static:/app/app/static:ro
      - ./app/contracts:/app/app/contracts:ro
      - app_logs:/app/logs
      - app_data:/app/data
    ports:
      - "${APP_PORT:-8000}:8000"
    networks:
      - foodcourt_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: foodcourt_nginx
    restart: unless-stopped
    depends_on:
      - app
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - foodcourt_network

networks:
  foodcourt_network:
    driver: bridge

volumes:
  db_data:
    driver: local
  app_logs:
    driver: local
  app_data:
    driver: local
  nginx_logs:
    driver: local

