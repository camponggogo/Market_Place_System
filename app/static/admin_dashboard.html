<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Court Management System - Admin Dashboard</title>
    <!-- Libraries for Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDummyKey&libraries=places" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=TH+Sarabun+New:wght@400;700&display=swap');
        
        * {
            font-family: 'TH Sarabun New', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #f5f5f5;
            font-size: 18px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #ddd;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-size: 18px;
            font-weight: bold;
        }
        
        .tab:hover {
            background: #f8f9fa;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
        }
        
        .content {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 22px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: bold;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-block {
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-used {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-refunded {
            background: #f8d7da;
            color: #721c24;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }
        
        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .payment-method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .badge-cash { background: #28a745; color: white; }
        .badge-card { background: #007bff; color: white; }
        .badge-wallet { background: #17a2b8; color: white; }
        .badge-crypto { background: #ffc107; color: #000; }
        .badge-points { background: #6f42c1; color: white; }
        
        .report-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .report-summary h3 {
            margin-bottom: 10px;
            color: #667eea;
        }
        
        .report-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .report-summary-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .report-summary-item label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .report-summary-item .value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        
        @media print {
            .header, .tabs, .card:not(#report-result), .btn, #report-actions {
                display: none !important;
            }
            .content {
                padding: 0;
            }
            #report-result {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üçΩÔ∏è Food Court Management System</h1>
        <p>Admin Dashboard - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</p>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="showTab('dashboard')">üìä Dashboard</div>
        <div class="tab" onclick="showTab('counter')">üíµ Counter</div>
        <div class="tab" onclick="showTab('payment')">üí≥ Payment Hub</div>
        <div class="tab" onclick="showTab('geo')">üó∫Ô∏è Geo Layout</div>
        <div class="tab" onclick="showTab('refund')">üí∞ Refund</div>
        <div class="tab" onclick="showTab('reports')">üìä Reports</div>
        <div class="tab" onclick="showTab('customers')">üë• Customers</div>
        <div class="tab" onclick="showTab('stores')">üè™ Stores</div>
    </div>
    
    <div class="content">
        <div id="alert-container"></div>
        
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <h3>Food Court IDs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="value" id="dashboard-total-fc-ids">0</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</h3>
                    <div class="value" id="dashboard-total-amount">0</div>
                </div>
                <div class="stat-card">
                    <h3>Transactions ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div class="value" id="dashboard-today-transactions">0</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div class="value" id="dashboard-today-sales">0</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="value" id="dashboard-total-customers">0</div>
                </div>
                <div class="stat-card">
                    <h3>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="value" id="dashboard-total-stores">0</div>
                </div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <h2>Transactions ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                    <div id="dashboard-recent-transactions"></div>
                </div>
                <div class="card">
                    <h2>Food Court IDs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                    <div id="dashboard-recent-fc-ids"></div>
                </div>
            </div>
        </div>
        
        <!-- Counter Tab -->
        <div id="counter" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‡πÅ‡∏•‡∏Å Food Court ID</h2>
                    <div class="form-group">
                        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="exchange-amount" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <select id="exchange-payment-method">
                            <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="line_pay">LINE Pay</option>
                            <option value="promptpay">PromptPay</option>
                            <option value="apple_pay">Apple Pay</option>
                            <option value="google_pay">Google Pay</option>
                            <option value="samsung_pay">Samsung Pay</option>
                            <option value="credit_card_visa">Visa</option>
                            <option value="credit_card_mastercard">Mastercard</option>
                            <option value="true_wallet">True Wallet</option>
                            <option value="shopee_pay">ShopeePay</option>
                            <option value="grab_pay">GrabPay</option>
                            <option value="paypal">PayPal</option>
                            <option value="crypto_btc">Bitcoin</option>
                            <option value="crypto_eth">Ethereum</option>
                            <option value="points_the1">The 1 Card Points</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Counter ID</label>
                        <input type="number" id="exchange-counter-id" value="1">
                    </div>
                    <div class="form-group">
                        <label>Counter User ID</label>
                        <input type="number" id="exchange-counter-user-id" value="1">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="exchangeFoodCourtID()">‡πÅ‡∏•‡∏Å Food Court ID</button>
                </div>
                
                <div class="card">
                    <h2>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</h2>
                    <div class="form-group">
                        <label>Food Court ID</label>
                        <input type="text" id="check-balance-id" placeholder="FC-20241201-12345">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="checkBalance()">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
                    <div id="balance-result" style="margin-top: 15px;"></div>
                </div>
                
                <div class="card">
                    <h2>‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h2>
                    <div class="form-group">
                        <label>Food Court ID</label>
                        <input type="text" id="refund-id" placeholder="FC-20241201-12345">
                    </div>
                    <div class="form-group">
                        <label>Counter ID</label>
                        <input type="number" id="refund-counter-id" value="1">
                    </div>
                    <button class="btn btn-success btn-block" onclick="refundBalance()">‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</button>
                </div>
            </div>
            
            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Food Court IDs ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <div class="search-box">
                    <input type="text" id="search-fc-ids" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Food Court ID..." onkeyup="searchFCIDs()">
                </div>
                <div id="fc-ids-list"></div>
            </div>
        </div>
        
        <!-- Payment Hub Tab -->
        <div id="payment" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‡πÉ‡∏ä‡πâ Food Court ID ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div class="form-group">
                        <label>Food Court ID</label>
                        <input type="text" id="use-fc-id" placeholder="FC-20241201-12345">
                    </div>
                    <div class="form-group">
                        <label>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="use-store-id"></select>
                    </div>
                    <div class="form-group">
                        <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="use-amount" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="useFoodCourtID()">‡πÉ‡∏ä‡πâ Food Court ID</button>
                </div>
                
                <div class="card">
                    <h2>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                    <div class="stats-grid" id="payment-stats">
                        <div class="stat-card">
                            <h3>Food Court IDs ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                            <div class="value" id="total-fc-ids">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</h3>
                            <div class="value" id="total-amount">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Transactions ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                            <div class="value" id="today-transactions">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transactions ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
                <div id="transactions-list"></div>
            </div>
        </div>
        
        <!-- Refund Tab -->
        <div id="refund" class="tab-content">
            <div class="card">
                <h2>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</h2>
                <div id="pending-refunds"></div>
            </div>
            
            <div class="card">
                <h2>‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <div class="form-group">
                    <label>Refund Request ID</label>
                    <input type="number" id="process-refund-id" placeholder="1">
                </div>
                <button class="btn btn-success btn-block" onclick="processRefund()">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
        
        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <div class="form-group">
                        <label>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <select id="report-store-id"></select>
                    </div>
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</label>
                        <input type="date" id="report-start-date">
                    </div>
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="report-end-date">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="getStoreReport()">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
                
                <div class="card">
                    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h2>
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <input type="date" id="report-daily-date">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="getDailyReport()">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
                
                <div class="card">
                    <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                    <div class="form-group">
                        <label>‡∏õ‡∏µ</label>
                        <input type="number" id="report-year" value="2024" min="2020" max="2099">
                    </div>
                    <div class="form-group">
                        <label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="report-month">
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-block" onclick="getMonthlyReport()">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h2>
                    <div id="report-actions" style="display: none;">
                        <button class="btn btn-primary" onclick="printReport()" style="margin-right: 10px;">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button class="btn btn-success" onclick="exportToPDF()" style="margin-right: 10px;">üìÑ Export PDF</button>
                        <button class="btn btn-success" onclick="exportToExcel()">üìä Export Excel</button>
                    </div>
                </div>
                <div id="report-result"></div>
            </div>
        </div>
        
        <!-- Customers Tab -->
        <div id="customers" class="tab-content">
            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                <div class="search-box">
                    <input type="text" id="search-customers" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£)..." onkeyup="searchCustomers()">
                </div>
                <div id="customers-list"></div>
            </div>
            
            <div class="card" id="customer-detail-card" style="display: none;">
                <h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Food Court ID</h2>
                <div id="customer-detail-info"></div>
                <div class="form-group" style="margin-top: 20px;">
                    <label>Food Court ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ:</label>
                    <div id="customer-fc-ids-list"></div>
                </div>
                <div class="form-group">
                    <label>‡∏ú‡∏π‡∏Å Food Court ID ‡πÉ‡∏´‡∏°‡πà:</label>
                    <input type="text" id="link-fc-id-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Food Court ID (‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)">
                    <button class="btn btn-primary" onclick="linkFoodCourtID()" style="margin-top: 10px;">‡∏ú‡∏π‡∏Å Food Court ID</button>
                </div>
            </div>
        </div>
        
        <!-- Stores Tab -->
        <div id="stores" class="tab-content">
            <div class="card">
                <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <div id="stores-list"></div>
            </div>
            
            <div class="card">
                <h2>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h2>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                    <input type="text" id="new-store-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô">
                </div>
                <div class="form-group">
                    <label>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ</label>
                    <input type="text" id="new-store-tax-id" placeholder="1234567890123">
                </div>
                <button class="btn btn-primary btn-block" onclick="createStore()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        let map = null;
        let markers = [];
        
        // Set default dates
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-daily-date').value = today;
            document.getElementById('report-start-date').value = today;
            document.getElementById('report-end-date').value = today;
            
            loadStores();
            loadCustomers();
            loadFCIDs();
            loadTransactions();
            loadPaymentStats();
            loadDashboardData();
            loadProfiles();
            initMap();
        });
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data for the tab
            if (tabName === 'dashboard') {
                loadDashboardData();
            } else if (tabName === 'payment') {
                loadTransactions();
                loadPaymentStats();
            } else if (tabName === 'customers') {
                loadCustomers();
            } else if (tabName === 'stores') {
                loadStores();
            } else if (tabName === 'refund') {
                loadPendingRefunds();
            } else if (tabName === 'geo') {
                loadProfiles();
                loadGeoStores();
            } else if (tabName === 'reports') {
                loadProfiles();
                loadEvents();
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        async function exchangeFoodCourtID() {
            const amount = parseFloat(document.getElementById('exchange-amount').value);
            const paymentMethod = document.getElementById('exchange-payment-method').value;
            const counterId = parseInt(document.getElementById('exchange-counter-id').value);
            const counterUserId = parseInt(document.getElementById('exchange-counter-user-id').value);
            
            if (!amount || amount <= 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/counter/exchange`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amount,
                        payment_method: paymentMethod,
                        counter_id: counterId,
                        counter_user_id: counterUserId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Food Court ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.foodcourt_id}`, 'success');
                    document.getElementById('exchange-amount').value = '';
                    loadFCIDs();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function checkBalance() {
            const fcId = document.getElementById('check-balance-id').value.trim();
            if (!fcId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Food Court ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/counter/balance/${fcId}`);
                const data = await response.json();
                
                if (response.ok) {
                    const resultDiv = document.getElementById('balance-result');
                    resultDiv.innerHTML = `
                        <div class="card" style="background: #f8f9fa;">
                            <h3>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                            <p style="font-size: 24px; font-weight: bold; color: #667eea;">
                                ${parseFloat(data.current_balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó
                            </p>
                            <p><strong>Food Court ID:</strong> ${data.foodcourt_id}</p>
                            <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</strong> ${parseFloat(data.initial_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</p>
                            <p><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</strong> ${data.payment_method}</p>
                            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-badge status-${data.status}">${data.status}</span></p>
                        </div>
                    `;
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function refundBalance() {
            const fcId = document.getElementById('refund-id').value.trim();
            const counterId = parseInt(document.getElementById('refund-counter-id').value);
            
            if (!fcId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Food Court ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/counter/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        foodcourt_id: fcId,
                        counter_id: counterId,
                        counter_user_id: 1
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${parseFloat(data.refund_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó`, 'success');
                    document.getElementById('refund-id').value = '';
                    loadFCIDs();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function useFoodCourtID() {
            const fcId = document.getElementById('use-fc-id').value.trim();
            const storeId = parseInt(document.getElementById('use-store-id').value);
            const amount = parseFloat(document.getElementById('use-amount').value);
            
            if (!fcId || !storeId || !amount) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/payment-hub/use`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        foodcourt_id: fcId,
                        store_id: storeId,
                        amount: amount
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ‡πÉ‡∏ä‡πâ Food Court ID ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${parseFloat(data.remaining_balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó`, 'success');
                    document.getElementById('use-fc-id').value = '';
                    document.getElementById('use-amount').value = '';
                    loadTransactions();
                    loadPaymentStats();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function loadStores() {
            try {
                const response = await fetch(`${API_BASE_URL}/stores/`);
                const stores = await response.json();
                
                // Populate store select
                const storeSelect = document.getElementById('use-store-id');
                const reportStoreSelect = document.getElementById('report-store-id');
                
                storeSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>';
                reportStoreSelect.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</option>';
                
                stores.forEach(store => {
                    const option1 = document.createElement('option');
                    option1.value = store.id;
                    option1.textContent = store.name;
                    storeSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = store.id;
                    option2.textContent = store.name;
                    reportStoreSelect.appendChild(option2);
                });
                
                // Display stores list
                const storesList = document.getElementById('stores-list');
                if (storesList) {
                    let html = '<table><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</th><th>Tax ID</th><th>Crypto</th><th>Contract</th></tr></thead><tbody>';
                    stores.forEach(store => {
                        html += `
                            <tr>
                                <td>${store.id}</td>
                                <td>${store.name}</td>
                                <td>${store.tax_id || '-'}</td>
                                <td>${store.crypto_enabled ? '‚úÖ' : '‚ùå'}</td>
                                <td>${store.contract_accepted ? '‚úÖ' : '‚ùå'}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    storesList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading stores:', error);
            }
        }
        
        async function loadFCIDs() {
            try {
                const response = await fetch(`${API_BASE_URL}/counter/foodcourt-ids?limit=50`);
                const fcIds = await response.json();
                
                const fcIdsList = document.getElementById('fc-ids-list');
                if (fcIdsList) {
                    if (fcIds.length === 0) {
                        fcIdsList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Food Court IDs</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>Food Court ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th></tr></thead><tbody>';
                    fcIds.forEach(fc => {
                        const statusClass = fc.status === 'active' ? 'status-active' : 
                                          fc.status === 'used' ? 'status-used' : 
                                          fc.status === 'refunded' ? 'status-refunded' : '';
                        html += `
                            <tr>
                                <td><strong>${fc.foodcourt_id}</strong></td>
                                <td>${parseFloat(fc.initial_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td>${parseFloat(fc.current_balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td><span class="payment-method-badge badge-${getPaymentMethodClass(fc.payment_method)}">${fc.payment_method}</span></td>
                                <td><span class="status-badge ${statusClass}">${fc.status}</span></td>
                                <td>${new Date(fc.created_at).toLocaleString('th-TH')}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    fcIdsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading FC IDs:', error);
                const fcIdsList = document.getElementById('fc-ids-list');
                if (fcIdsList) {
                    fcIdsList.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                }
            }
        }
        
        async function loadTransactions() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/transactions?limit=50`);
                const transactions = await response.json();
                
                const transactionsList = document.getElementById('transactions-list');
                if (transactionsList) {
                    if (transactions.length === 0) {
                        transactionsList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Transactions</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>ID</th><th>Food Court ID</th><th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead><tbody>';
                    transactions.forEach(t => {
                        html += `
                            <tr>
                                <td>${t.id}</td>
                                <td>${t.foodcourt_id || '-'}</td>
                                <td>‡∏£‡πâ‡∏≤‡∏ô #${t.store_id}</td>
                                <td>${parseFloat(t.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td><span class="payment-method-badge badge-${getPaymentMethodClass(t.payment_method)}">${t.payment_method}</span></td>
                                <td><span class="status-badge status-${t.status}">${t.status}</span></td>
                                <td>${new Date(t.created_at).toLocaleString('th-TH')}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    transactionsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                const transactionsList = document.getElementById('transactions-list');
                if (transactionsList) {
                    transactionsList.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                }
            }
        }
        
        async function loadPaymentStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/statistics`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                
                // Check if elements exist before updating
                const totalFcIdsEl = document.getElementById('total-fc-ids');
                const totalAmountEl = document.getElementById('total-amount');
                const todayTransEl = document.getElementById('today-transactions');
                
                if (totalFcIdsEl) {
                    totalFcIdsEl.textContent = (stats.foodcourt_ids?.total || 0).toLocaleString('th-TH');
                }
                if (totalAmountEl) {
                    totalAmountEl.textContent = parseFloat(stats.amounts?.total_initial || 0).toLocaleString('th-TH', {minimumFractionDigits: 2});
                }
                if (todayTransEl) {
                    todayTransEl.textContent = (stats.today?.transactions || 0).toLocaleString('th-TH');
                }
            } catch (error) {
                console.error('Error loading payment stats:', error);
                const totalFcIdsEl = document.getElementById('total-fc-ids');
                const totalAmountEl = document.getElementById('total-amount');
                const todayTransEl = document.getElementById('today-transactions');
                
                if (totalFcIdsEl) totalFcIdsEl.textContent = '0';
                if (totalAmountEl) totalAmountEl.textContent = '0.00';
                if (todayTransEl) todayTransEl.textContent = '0';
            }
        }
        
        let selectedCustomerId = null;
        
        async function loadCustomers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/customers?limit=100`);
                const customers = await response.json();
                
                const customersList = document.getElementById('customers-list');
                if (customersList) {
                    if (customers.length === 0) {
                        customersList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>PromptPay</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>Food Court IDs</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                    customers.forEach(c => {
                        html += `
                            <tr>
                                <td>${c.id}</td>
                                <td>${c.name || '-'}</td>
                                <td>${c.phone}</td>
                                <td>${c.promptpay_number || '-'}</td>
                                <td>${parseFloat(c.balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td>${c.foodcourt_ids_count || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                                <td>${new Date(c.created_at).toLocaleDateString('th-TH')}</td>
                                <td><button class="btn btn-sm" onclick="showCustomerDetail(${c.id})">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</button></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    customersList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                const customersList = document.getElementById('customers-list');
                if (customersList) {
                    customersList.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                }
            }
        }
        
        async function showCustomerDetail(customerId) {
            selectedCustomerId = customerId;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/customers?limit=100`);
                const customers = await response.json();
                const customer = customers.find(c => c.id === customerId);
                
                if (!customer) {
                    showAlert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'error');
                    return;
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
                const detailInfo = document.getElementById('customer-detail-info');
                detailInfo.innerHTML = `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                        <p><strong>ID:</strong> ${customer.id}</p>
                        <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${customer.name || '-'}</p>
                        <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${customer.phone}</p>
                        <p><strong>PromptPay:</strong> ${customer.promptpay_number || '-'}</p>
                        <p><strong>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong> ${parseFloat(customer.balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</p>
                    </div>
                `;
                
                // ‡πÅ‡∏™‡∏î‡∏á Food Court IDs ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ
                const fcIdsList = document.getElementById('customer-fc-ids-list');
                if (customer.foodcourt_ids && customer.foodcourt_ids.length > 0) {
                    let html = '<div style="display: grid; gap: 10px;">';
                    customer.foodcourt_ids.forEach(fcId => {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border: 1px solid #ddd; border-radius: 5px;">
                                <span><strong>${fcId}</strong></span>
                                <button class="btn btn-sm btn-danger" onclick="unlinkFoodCourtID('${fcId}')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å</button>
                            </div>
                        `;
                    });
                    html += '</div>';
                    fcIdsList.innerHTML = html;
                } else {
                    fcIdsList.innerHTML = '<p style="color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Food Court ID ‡∏ó‡∏µ‡πà‡∏ú‡∏π‡∏Å‡πÑ‡∏ß‡πâ</p>';
                }
                
                // ‡πÅ‡∏™‡∏î‡∏á card
                document.getElementById('customer-detail-card').style.display = 'block';
                document.getElementById('link-fc-id-input').value = '';
                
            } catch (error) {
                console.error('Error loading customer detail:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }
        
        async function linkFoodCourtID() {
            if (!selectedCustomerId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            const fcId = document.getElementById('link-fc-id-input').value.trim();
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/customers/link-foodcourt-id`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_id: selectedCustomerId,
                        foodcourt_id: fcId || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    document.getElementById('link-fc-id-input').value = '';
                    showCustomerDetail(selectedCustomerId);
                    loadCustomers();
                } else {
                    showAlert('‚ùå ' + (data.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'), 'error');
                }
            } catch (error) {
                console.error('Error linking Food Court ID:', error);
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        }
        
        async function unlinkFoodCourtID(foodcourtId) {
            if (!selectedCustomerId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡∏Å Food Court ID ${foodcourtId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/customers/${selectedCustomerId}/foodcourt-id/${foodcourtId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('‚úÖ ' + data.message, 'success');
                    showCustomerDetail(selectedCustomerId);
                    loadCustomers();
                } else {
                    showAlert('‚ùå ' + (data.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'), 'error');
                }
            } catch (error) {
                console.error('Error unlinking Food Court ID:', error);
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        }
        
        function getPaymentMethodClass(method) {
            if (method.includes('cash')) return 'cash';
            if (method.includes('credit_card') || method.includes('card')) return 'card';
            if (method.includes('wallet') || method.includes('pay')) return 'wallet';
            if (method.includes('crypto')) return 'crypto';
            if (method.includes('points')) return 'points';
            return 'cash';
        }
        
        async function loadPendingRefunds() {
            try {
                const response = await fetch(`${API_BASE_URL}/refunds/pending`);
                const refunds = await response.json();
                
                const pendingRefunds = document.getElementById('pending-refunds');
                if (pendingRefunds) {
                    if (refunds.length === 0) {
                        pendingRefunds.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</p>';
                    } else {
                        let html = '<table><thead><tr><th>ID</th><th>Customer ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead><tbody>';
                        refunds.forEach(refund => {
                            html += `
                                <tr>
                                    <td>${refund.id}</td>
                                    <td>${refund.customer_id}</td>
                                    <td>${parseFloat(refund.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                    <td>${refund.refund_method}</td>
                                    <td>${refund.status}</td>
                                    <td>${new Date(refund.created_at).toLocaleString('th-TH')}</td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                        pendingRefunds.innerHTML = html;
                    }
                }
            } catch (error) {
                console.error('Error loading pending refunds:', error);
            }
        }
        
        async function processRefund() {
            const refundId = parseInt(document.getElementById('process-refund-id').value);
            if (!refundId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Refund Request ID', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/refunds/${refundId}/process`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('‚úÖ ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    document.getElementById('process-refund-id').value = '';
                    loadPendingRefunds();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function getStoreReport() {
            const storeId = parseInt(document.getElementById('report-store-id').value);
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!storeId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports/payment/store/${storeId}?start_date=${startDate}&end_date=${endDate}`);
                const data = await response.json();
                
                displayReport(data);
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function getDailyReport() {
            const date = document.getElementById('report-daily-date').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports/payment/daily?date=${date}`);
                const data = await response.json();
                
                displayReport(data);
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function getMonthlyReport() {
            const year = parseInt(document.getElementById('report-year').value);
            const month = parseInt(document.getElementById('report-month').value);
            
            try {
                const response = await fetch(`${API_BASE_URL}/reports/payment/monthly?year=${year}&month=${month}`);
                const data = await response.json();
                
                displayReport(data);
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        let currentReportData = null;
        let currentReportType = null;
        
        function displayReport(data) {
            currentReportData = data;
            const reportResult = document.getElementById('report-result');
            const reportActions = document.getElementById('report-actions');
            
            // Show action buttons
            reportActions.style.display = 'block';
            
            let html = '';
            
            // Detect report type and display accordingly
            if (data.store_id !== undefined) {
                // Store Report
                currentReportType = 'store';
                html = renderStoreReport(data);
            } else if (data.date !== undefined) {
                // Daily Report
                currentReportType = 'daily';
                html = renderDailyReport(data);
            } else if (data.year !== undefined && data.month !== undefined) {
                // Monthly Report
                currentReportType = 'monthly';
                html = renderMonthlyReport(data);
            } else {
                // Fallback to JSON
                html = `<pre style="background: #f8f9fa; padding: 20px; border-radius: 5px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            reportResult.innerHTML = html;
        }
        
        function renderStoreReport(data) {
            let html = '<div class="report-summary">';
            html += '<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>';
            html += '<div class="report-summary-grid">';
            html += `<div class="report-summary-item"><label>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ID</label><div class="value">${data.store_id}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Transactions</label><div class="value">${data.summary.total_transactions}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</label><div class="value">${parseFloat(data.summary.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label><div class="value">${new Date(data.period.start_date).toLocaleDateString('th-TH')} - ${new Date(data.period.end_date).toLocaleDateString('th-TH')}</div></div>`;
            html += '</div></div>';
            
            // Payment Method Summary
            if (data.by_payment_method && Object.keys(data.by_payment_method).length > 0) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>';
                html += '<table><thead><tr><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>';
                for (const [method, summary] of Object.entries(data.by_payment_method)) {
                    html += `<tr>
                        <td><span class="payment-method-badge badge-${getPaymentMethodClass(method)}">${method}</span></td>
                        <td>${summary.count}</td>
                        <td>${parseFloat(summary.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>`;
                }
                html += '</tbody></table></div>';
            }
            
            // Transactions List
            if (data.transactions && data.transactions.length > 0) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transactions</h3>';
                html += '<table><thead><tr><th>ID</th><th>Food Court ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead><tbody>';
                data.transactions.forEach(t => {
                    html += `<tr>
                        <td>${t.id}</td>
                        <td>${t.foodcourt_id}</td>
                        <td>${parseFloat(t.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                        <td>${new Date(t.created_at).toLocaleString('th-TH')}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            return html;
        }
        
        function renderDailyReport(data) {
            let html = '<div class="report-summary">';
            html += '<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';
            html += '<div class="report-summary-grid">';
            html += `<div class="report-summary-item"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><div class="value">${new Date(data.date).toLocaleDateString('th-TH')}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label><div class="value">${data.exchange.transaction_count}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)</label><div class="value">${parseFloat(data.exchange.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label><div class="value">${data.usage.transaction_count}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)</label><div class="value">${parseFloat(data.usage.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div></div>`;
            html += '</div></div>';
            
            // Payment Method Summary
            if (data.by_payment_method && Object.keys(data.by_payment_method).length > 0) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>';
                html += '<table><thead><tr><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>';
                for (const [method, summary] of Object.entries(data.by_payment_method)) {
                    html += `<tr>
                        <td><span class="payment-method-badge badge-${getPaymentMethodClass(method)}">${method}</span></td>
                        <td>${summary.count}</td>
                        <td>${parseFloat(summary.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>`;
                }
                html += '</tbody></table></div>';
            }
            
            // Store Summary
            if (data.by_store && data.by_store.length > 0) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>';
                html += '<table><thead><tr><th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>';
                data.by_store.forEach(store => {
                    html += `<tr>
                        <td>${store.store_name} (ID: ${store.store_id})</td>
                        <td>${store.count}</td>
                        <td>${parseFloat(store.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            return html;
        }
        
        function renderMonthlyReport(data) {
            let html = '<div class="report-summary">';
            html += '<h3>‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>';
            html += '<div class="report-summary-grid">';
            html += `<div class="report-summary-item"><label>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ</label><div class="value">${data.month}/${data.year}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label><div class="value">${data.exchange.transaction_count}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)</label><div class="value">${parseFloat(data.exchange.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)</label><div class="value">${data.usage.transaction_count}</div></div>`;
            html += `<div class="report-summary-item"><label>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)</label><div class="value">${parseFloat(data.usage.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div></div>`;
            html += '</div></div>';
            
            // Store Summary
            if (data.by_store && data.by_store.length > 0) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>';
                html += '<table><thead><tr><th>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</th></tr></thead><tbody>';
                data.by_store.forEach(store => {
                    html += `<tr>
                        <td>${store.store_name} (ID: ${store.store_id})</td>
                        <td>${store.count}</td>
                        <td>${parseFloat(store.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            // Daily Summaries (if available and not too many)
            if (data.daily_summaries && data.daily_summaries.length > 0 && data.daily_summaries.length <= 31) {
                html += '<div class="card" style="margin-top: 20px;"><h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</h3>';
                html += '<table><thead><tr><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å</th><th>‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th></tr></thead><tbody>';
                data.daily_summaries.forEach(daily => {
                    html += `<tr>
                        <td>${new Date(daily.date).toLocaleDateString('th-TH')}</td>
                        <td>${parseFloat(daily.exchange.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó (${daily.exchange.transaction_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</td>
                        <td>${parseFloat(daily.usage.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó (${daily.usage.transaction_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }
            
            return html;
        }
        
        function printReport() {
            window.print();
        }
        
        function exportToPDF() {
            if (!currentReportData) {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            let title = '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô';
            if (currentReportType === 'store') {
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ID: ${currentReportData.store_id}`;
            } else if (currentReportType === 'daily') {
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô - ${new Date(currentReportData.date).toLocaleDateString('th-TH')}`;
            } else if (currentReportType === 'monthly') {
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô - ${currentReportData.month}/${currentReportData.year}`;
            }
            
            doc.setFontSize(16);
            doc.text(title, 14, 15);
            
            let yPos = 25;
            
            // Summary data
            const summaryData = [];
            if (currentReportType === 'store') {
                summaryData.push(['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ID', currentReportData.store_id]);
                summaryData.push(['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Transactions', currentReportData.summary.total_transactions]);
                summaryData.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', parseFloat(currentReportData.summary.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})]);
            } else if (currentReportType === 'daily') {
                summaryData.push(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', new Date(currentReportData.date).toLocaleDateString('th-TH')]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.exchange.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', parseFloat(currentReportData.exchange.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó']);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.usage.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', parseFloat(currentReportData.usage.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó']);
            } else if (currentReportType === 'monthly') {
                summaryData.push(['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ', `${currentReportData.month}/${currentReportData.year}`]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.exchange.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', parseFloat(currentReportData.exchange.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó']);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.usage.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', parseFloat(currentReportData.usage.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó']);
            }
            
            doc.autoTable({
                startY: yPos,
                head: [['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏Ñ‡πà‡∏≤']],
                body: summaryData,
                theme: 'striped'
            });
            
            yPos = doc.lastAutoTable.finalY + 10;
            
            // Payment Method table
            if (currentReportData.by_payment_method && Object.keys(currentReportData.by_payment_method).length > 0) {
                const paymentData = [['‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)']];
                for (const [method, summary] of Object.entries(currentReportData.by_payment_method)) {
                    paymentData.push([
                        method,
                        summary.count.toString(),
                        parseFloat(summary.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})
                    ]);
                }
                
                doc.autoTable({
                    startY: yPos,
                    head: [paymentData[0]],
                    body: paymentData.slice(1),
                    theme: 'striped'
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // Store table
            if (currentReportData.by_store && currentReportData.by_store.length > 0) {
                const storeData = [['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)']];
                currentReportData.by_store.forEach(store => {
                    storeData.push([
                        `${store.store_name} (ID: ${store.store_id})`,
                        store.count.toString(),
                        parseFloat(store.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})
                    ]);
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [storeData[0]],
                    body: storeData.slice(1),
                    theme: 'striped'
                });
            }
            
            // Save PDF
            const filename = `report_${currentReportType}_${new Date().getTime()}.pdf`;
            doc.save(filename);
            showAlert('‚úÖ Export PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        
        function exportToExcel() {
            if (!currentReportData) {
                showAlert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', 'error');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [];
            if (currentReportType === 'store') {
                summaryData.push(['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏Ñ‡πà‡∏≤']);
                summaryData.push(['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ID', currentReportData.store_id]);
                summaryData.push(['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Transactions', currentReportData.summary.total_transactions]);
                summaryData.push(['‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)', currentReportData.summary.total_amount]);
            } else if (currentReportType === 'daily') {
                summaryData.push(['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏Ñ‡πà‡∏≤']);
                summaryData.push(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', new Date(currentReportData.date).toLocaleDateString('th-TH')]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.exchange.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', currentReportData.exchange.total_amount]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.usage.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', currentReportData.usage.total_amount]);
            } else if (currentReportType === 'monthly') {
                summaryData.push(['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏Ñ‡πà‡∏≤']);
                summaryData.push(['‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ', `${currentReportData.month}/${currentReportData.year}`]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.exchange.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏Å (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', currentReportData.exchange.total_amount]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', currentReportData.usage.transaction_count]);
                summaryData.push(['‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°)', currentReportData.usage.total_amount]);
            }
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, '‡∏™‡∏£‡∏∏‡∏õ');
            
            // Payment Method sheet
            if (currentReportData.by_payment_method && Object.keys(currentReportData.by_payment_method).length > 0) {
                const paymentData = [['‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)']];
                for (const [method, summary] of Object.entries(currentReportData.by_payment_method)) {
                    paymentData.push([method, summary.count, summary.amount]);
                }
                const ws2 = XLSX.utils.aoa_to_sheet(paymentData);
                XLSX.utils.book_append_sheet(wb, ws2, '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
            }
            
            // Store sheet
            if (currentReportData.by_store && currentReportData.by_store.length > 0) {
                const storeData = [['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'ID', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)']];
                currentReportData.by_store.forEach(store => {
                    storeData.push([store.store_name, store.store_id, store.count, store.amount]);
                });
                const ws3 = XLSX.utils.aoa_to_sheet(storeData);
                XLSX.utils.book_append_sheet(wb, ws3, '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
            }
            
            // Transactions sheet
            if (currentReportData.transactions && currentReportData.transactions.length > 0) {
                const transData = [['ID', 'Food Court ID', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']];
                currentReportData.transactions.forEach(t => {
                    transData.push([
                        t.id,
                        t.foodcourt_id,
                        t.amount,
                        new Date(t.created_at).toLocaleString('th-TH')
                    ]);
                });
                const ws4 = XLSX.utils.aoa_to_sheet(transData);
                XLSX.utils.book_append_sheet(wb, ws4, 'Transactions');
            }
            
            // Save Excel
            const filename = `report_${currentReportType}_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(wb, filename);
            showAlert('‚úÖ Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        }
        
        async function createStore() {
            const name = document.getElementById('new-store-name').value.trim();
            const taxId = document.getElementById('new-store-tax-id').value.trim();
            
            if (!name) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/stores/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        tax_id: taxId || null
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.name}`, 'success');
                    document.getElementById('new-store-name').value = '';
                    document.getElementById('new-store-tax-id').value = '';
                    loadStores();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        async function searchFCIDs() {
            const searchTerm = document.getElementById('search-fc-ids').value.trim();
            try {
                const url = searchTerm 
                    ? `${API_BASE_URL}/counter/foodcourt-ids?limit=100`
                    : `${API_BASE_URL}/counter/foodcourt-ids?limit=50`;
                const response = await fetch(url);
                const fcIds = await response.json();
                
                let filtered = fcIds;
                if (searchTerm) {
                    filtered = fcIds.filter(fc => 
                        fc.foodcourt_id.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                }
                
                const fcIdsList = document.getElementById('fc-ids-list');
                if (fcIdsList) {
                    if (filtered.length === 0) {
                        fcIdsList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö Food Court ID ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>Food Court ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th></tr></thead><tbody>';
                    filtered.forEach(fc => {
                        const statusClass = fc.status === 'active' ? 'status-active' : 
                                          fc.status === 'used' ? 'status-used' : 
                                          fc.status === 'refunded' ? 'status-refunded' : '';
                        html += `
                            <tr>
                                <td><strong>${fc.foodcourt_id}</strong></td>
                                <td>${parseFloat(fc.initial_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td>${parseFloat(fc.current_balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td><span class="payment-method-badge badge-${getPaymentMethodClass(fc.payment_method)}">${fc.payment_method}</span></td>
                                <td><span class="status-badge ${statusClass}">${fc.status}</span></td>
                                <td>${new Date(fc.created_at).toLocaleString('th-TH')}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    fcIdsList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error searching FC IDs:', error);
            }
        }
        
        async function searchCustomers() {
            const searchTerm = document.getElementById('search-customers').value.trim();
            try {
                const url = searchTerm 
                    ? `${API_BASE_URL}/admin/customers?search=${encodeURIComponent(searchTerm)}&limit=100`
                    : `${API_BASE_URL}/admin/customers?limit=100`;
                const response = await fetch(url);
                const customers = await response.json();
                
                const customersList = document.getElementById('customers-list');
                if (customersList) {
                    if (customers.length === 0) {
                        customersList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</p>';
                        return;
                    }
                    
                    let html = '<table><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th><th>PromptPay</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th></tr></thead><tbody>';
                    customers.forEach(c => {
                        html += `
                            <tr>
                                <td>${c.id}</td>
                                <td>${c.name || '-'}</td>
                                <td>${c.phone}</td>
                                <td>${c.promptpay_number || '-'}</td>
                                <td>${parseFloat(c.balance).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                <td>${new Date(c.created_at).toLocaleDateString('th-TH')}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    customersList.innerHTML = html;
                }
            } catch (error) {
                console.error('Error searching customers:', error);
            }
        }
        
        // Dashboard Functions
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/statistics`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const stats = await response.json();
                console.log('Dashboard stats loaded:', stats);
                
                // Check if elements exist before updating
                const totalFcIdsEl = document.getElementById('dashboard-total-fc-ids');
                const totalAmountEl = document.getElementById('dashboard-total-amount');
                const todayTransEl = document.getElementById('dashboard-today-transactions');
                const todaySalesEl = document.getElementById('dashboard-today-sales');
                const totalCustomersEl = document.getElementById('dashboard-total-customers');
                const totalStoresEl = document.getElementById('dashboard-total-stores');
                
                if (totalFcIdsEl) {
                    totalFcIdsEl.textContent = (stats.foodcourt_ids?.total || 0).toLocaleString('th-TH');
                }
                if (totalAmountEl) {
                    totalAmountEl.textContent = parseFloat(stats.amounts?.total_initial || 0).toLocaleString('th-TH', {minimumFractionDigits: 2});
                }
                if (todayTransEl) {
                    todayTransEl.textContent = (stats.today?.transactions || 0).toLocaleString('th-TH');
                }
                if (todaySalesEl) {
                    todaySalesEl.textContent = parseFloat(stats.today?.sales || 0).toLocaleString('th-TH', {minimumFractionDigits: 2});
                }
                if (totalCustomersEl) {
                    totalCustomersEl.textContent = (stats.customers?.total || 0).toLocaleString('th-TH');
                }
                if (totalStoresEl) {
                    totalStoresEl.textContent = (stats.stores?.total || 0).toLocaleString('th-TH');
                }
                
                // Load recent transactions
                try {
                    const transResponse = await fetch(`${API_BASE_URL}/admin/transactions?limit=5`);
                    if (transResponse.ok) {
                        const transactions = await transResponse.json();
                        const recentTransDiv = document.getElementById('dashboard-recent-transactions');
                        if (recentTransDiv) {
                            if (transactions.length === 0) {
                                recentTransDiv.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Transactions</p>';
                            } else {
                                let html = '<table><thead><tr><th>ID</th><th>Food Court ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead><tbody>';
                                transactions.forEach(t => {
                                    html += `<tr>
                                        <td>${t.id}</td>
                                        <td>${t.foodcourt_id || '-'}</td>
                                        <td>${parseFloat(t.amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                        <td>${new Date(t.created_at).toLocaleString('th-TH')}</td>
                                    </tr>`;
                                });
                                html += '</tbody></table>';
                                recentTransDiv.innerHTML = html;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading recent transactions:', error);
                    const recentTransDiv = document.getElementById('dashboard-recent-transactions');
                    if (recentTransDiv) {
                        recentTransDiv.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                    }
                }
                
                // Load recent FC IDs
                try {
                    const fcResponse = await fetch(`${API_BASE_URL}/counter/foodcourt-ids?limit=5`);
                    if (fcResponse.ok) {
                        const fcIds = await fcResponse.json();
                        const recentFcDiv = document.getElementById('dashboard-recent-fc-ids');
                        if (recentFcDiv) {
                            if (fcIds.length === 0) {
                                recentFcDiv.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Food Court IDs</p>';
                            } else {
                                let html = '<table><thead><tr><th>Food Court ID</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th></tr></thead><tbody>';
                                fcIds.forEach(fc => {
                                    html += `<tr>
                                        <td><strong>${fc.foodcourt_id}</strong></td>
                                        <td>${parseFloat(fc.initial_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</td>
                                        <td><span class="status-badge status-${fc.status}">${fc.status}</span></td>
                                        <td>${new Date(fc.created_at).toLocaleString('th-TH')}</td>
                                    </tr>`;
                                });
                                html += '</tbody></table>';
                                recentFcDiv.innerHTML = html;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error loading recent FC IDs:', error);
                    const recentFcDiv = document.getElementById('dashboard-recent-fc-ids');
                    if (recentFcDiv) {
                        recentFcDiv.innerHTML = '<p style="color: red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Set default values on error
                const totalFcIdsEl = document.getElementById('dashboard-total-fc-ids');
                const totalAmountEl = document.getElementById('dashboard-total-amount');
                const todayTransEl = document.getElementById('dashboard-today-transactions');
                const todaySalesEl = document.getElementById('dashboard-today-sales');
                const totalCustomersEl = document.getElementById('dashboard-total-customers');
                const totalStoresEl = document.getElementById('dashboard-total-stores');
                
                if (totalFcIdsEl) totalFcIdsEl.textContent = '0';
                if (totalAmountEl) totalAmountEl.textContent = '0.00';
                if (todayTransEl) todayTransEl.textContent = '0';
                if (todaySalesEl) todaySalesEl.textContent = '0.00';
                if (totalCustomersEl) totalCustomersEl.textContent = '0';
                if (totalStoresEl) totalStoresEl.textContent = '0';
            }
        }
        
        // Profile and Event Functions
        async function loadProfiles() {
            try {
                const response = await fetch(`${API_BASE_URL}/profiles/`);
                const profiles = await response.json();
                
                const geoProfileSelect = document.getElementById('geo-profile-id');
                const reportProfileSelect = document.getElementById('report-profile-id');
                
                if (geoProfileSelect) {
                    geoProfileSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = `${profile.name} (${profile.profile_type})`;
                        geoProfileSelect.appendChild(option);
                    });
                }
                
                if (reportProfileSelect) {
                    reportProfileSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = `${profile.name} (${profile.profile_type})`;
                        reportProfileSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
            }
        }
        
        async function loadEvents() {
            try {
                const profileId = document.getElementById('report-profile-id')?.value;
                const url = profileId 
                    ? `${API_BASE_URL}/profiles/events/?profile_id=${profileId}`
                    : `${API_BASE_URL}/profiles/events/`;
                
                const response = await fetch(url);
                const events = await response.json();
                
                const reportEventSelect = document.getElementById('report-event-id');
                if (reportEventSelect) {
                    reportEventSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.name} (${new Date(event.start_date).toLocaleDateString('th-TH')} - ${new Date(event.end_date).toLocaleDateString('th-TH')})`;
                        reportEventSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        async function loadEventsForProfile() {
            const profileId = document.getElementById('geo-profile-id')?.value;
            try {
                const url = profileId 
                    ? `${API_BASE_URL}/profiles/events/?profile_id=${profileId}`
                    : `${API_BASE_URL}/profiles/events/`;
                
                const response = await fetch(url);
                const events = await response.json();
                
                const geoEventSelect = document.getElementById('geo-event-id');
                if (geoEventSelect) {
                    geoEventSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    events.forEach(event => {
                        const option = document.createElement('option');
                        option.value = event.id;
                        option.textContent = `${event.name} (${new Date(event.start_date).toLocaleDateString('th-TH')} - ${new Date(event.end_date).toLocaleDateString('th-TH')})`;
                        geoEventSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
        
        async function createProfile() {
            const name = document.getElementById('new-profile-name').value.trim();
            const type = document.getElementById('new-profile-type').value;
            
            if (!name) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ Profile', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/profiles/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        profile_type: type
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Profile ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${data.name}`, 'success');
                    document.getElementById('new-profile-name').value = '';
                    loadProfiles();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        // Geo Layout Functions
        function initMap() {
            // Initialize map centered on Thailand
            if (typeof google !== 'undefined' && google.maps) {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 13.7563, lng: 100.5018 }, // Bangkok
                    zoom: 15
                });
            } else {
                // Fallback: Use Leaflet if Google Maps not available
                document.getElementById('map').innerHTML = '<p style="padding: 20px; text-align: center;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° Google Maps API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</p>';
            }
        }
        
        async function loadGeoStores() {
            const profileId = document.getElementById('geo-profile-id')?.value || null;
            const eventId = document.getElementById('geo-event-id')?.value || null;
            
            try {
                let url = `${API_BASE_URL}/geo/stores?`;
                if (profileId) url += `profile_id=${profileId}&`;
                if (eventId) url += `event_id=${eventId}`;
                
                const response = await fetch(url);
                const stores = await response.json();
                
                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                markers = [];
                
                // Display stores list
                const storesList = document.getElementById('geo-stores-list');
                if (storesList) {
                    if (stores.length === 0) {
                        storesList.innerHTML = '<p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                    } else {
                        let html = '<table><thead><tr><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</th><th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th><th>Profile</th><th>Event</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead><tbody>';
                        stores.forEach(store => {
                            html += `<tr>
                                <td>${store.id}</td>
                                <td>${store.name}</td>
                                <td>${store.location_name || '-'} ${store.latitude && store.longitude ? `(${store.latitude}, ${store.longitude})` : ''}</td>
                                <td>${store.profile_name || '-'}</td>
                                <td>${store.event_name || '-'}</td>
                                <td><button class="btn btn-primary" onclick="editStoreLocation(${store.id})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button></td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                        storesList.innerHTML = html;
                    }
                }
                
                // Add markers to map
                if (map && typeof google !== 'undefined' && google.maps) {
                    stores.forEach(store => {
                        if (store.latitude && store.longitude) {
                            const marker = new google.maps.Marker({
                                position: { lat: store.latitude, lng: store.longitude },
                                map: map,
                                title: store.name,
                                label: store.location_name || store.name
                            });
                            
                            const infoWindow = new google.maps.InfoWindow({
                                content: `
                                    <div style="padding: 10px;">
                                        <h3>${store.name}</h3>
                                        <p>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${store.location_name || '-'}</p>
                                        <p>Profile: ${store.profile_name || '-'}</p>
                                        <p>Event: ${store.event_name || '-'}</p>
                                    </div>
                                `
                            });
                            
                            marker.addListener('click', () => {
                                infoWindow.open(map, marker);
                            });
                            
                            markers.push(marker);
                        }
                    });
                    
                    // Fit bounds to show all markers
                    if (markers.length > 0) {
                        const bounds = new google.maps.LatLngBounds();
                        markers.forEach(marker => {
                            bounds.extend(marker.getPosition());
                        });
                        map.fitBounds(bounds);
                    }
                }
            } catch (error) {
                console.error('Error loading geo stores:', error);
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        function editStoreLocation(storeId) {
            const lat = prompt('‡∏Å‡∏£‡∏≠‡∏Å Latitude:');
            const lng = prompt('‡∏Å‡∏£‡∏≠‡∏Å Longitude:');
            const locationName = prompt('‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡πá‡∏≠‡∏Å A1):');
            
            if (lat && lng) {
                updateStoreLocation(storeId, parseFloat(lat), parseFloat(lng), locationName);
            }
        }
        
        async function updateStoreLocation(storeId, lat, lng, locationName) {
            try {
                const response = await fetch(`${API_BASE_URL}/geo/stores/${storeId}/location`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        location_name: locationName
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                    loadGeoStores();
                } else {
                    showAlert('‚ùå ' + data.detail, 'error');
                }
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
        
        // Update report functions to support profile and event
        async function getStoreReport() {
            const storeId = parseInt(document.getElementById('report-store-id').value);
            const profileId = document.getElementById('report-profile-id')?.value || null;
            const eventId = document.getElementById('report-event-id')?.value || null;
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!storeId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤', 'error');
                return;
            }
            
            try {
                let url = `${API_BASE_URL}/reports/payment/store/${storeId}?start_date=${startDate}&end_date=${endDate}`;
                if (profileId) url += `&profile_id=${profileId}`;
                if (eventId) url += `&event_id=${eventId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                displayReport(data);
            } catch (error) {
                showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>

