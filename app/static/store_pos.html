<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store POS - Food Court Management System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=TH+Sarabun+New:wght@400;700&display=swap');
        
        * {
            font-family: 'TH Sarabun New', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #f5f5f5;
            font-size: 22px;
        }
        
        .store-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 16px;
        }
        
        .store-header h1 {
            font-size: 22px;
            margin: 0;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .store-info {
            display: flex;
            flex-wrap: nowrap;
            align-items: stretch;
            gap: 10px;
            margin: 0;
            flex: 1;
            min-width: 0;
        }
        
        .store-info-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 10px;
            border-radius: 6px;
            flex: 1 1 0;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .store-info-item label {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 2px;
            line-height: 1.2;
        }
        
        .store-info-item .value {
            font-size: 14px;
            font-weight: bold;
            line-height: 1.3;
        }
        
        /* Mobile Portrait - Compact Store Header but keep large fonts */
        @media (max-width: 768px) and (orientation: portrait) {
            body {
                font-size: 20px;
            }
            
            .store-header {
                padding: 8px 10px;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .store-header h1 {
                font-size: 18px;
                width: 100%;
            }
            
            .store-info {
                flex-wrap: wrap;
                gap: 6px;
                width: 100%;
            }
            
            .store-info-item {
                flex: 1 1 calc(33.333% - 6px);
                min-width: 80px;
                padding: 5px 6px;
            }
            
            .store-info-item label {
                font-size: 11px;
                margin-bottom: 1px;
            }
            
            .store-info-item .value {
                font-size: 12px;
            }
            
            .container {
                margin: 10px auto;
                padding: 0 10px;
            }
            
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .card h2 {
                font-size: 24px;
                margin-bottom: 15px;
                padding-bottom: 8px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 20px;
                margin-bottom: 8px;
            }
            
            .form-group input {
                padding: 18px;
                font-size: 22px;
            }
            
            #amount-input {
                font-size: 42px !important;
            }
            
            .quick-amount-buttons {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .quick-amount-btn {
                padding: 15px;
                font-size: 18px;
                min-height: 55px;
            }
            
            .btn {
                padding: 18px 20px;
                font-size: 22px;
                margin-bottom: 10px;
                min-height: 60px;
            }
            
            .qr-scanner-area {
                padding: 18px;
                margin-bottom: 18px;
            }
            
            .qr-scanner-area p {
                font-size: 18px;
            }
            
            .balance-display {
                padding: 25px;
                margin-bottom: 18px;
            }
            
            .balance-label {
                font-size: 20px;
            }
            
            .balance-amount {
                font-size: 48px;
            }
            
            .balance-info {
                font-size: 18px;
            }
            
            .transaction-history {
                margin-top: 20px;
            }
            
            .transaction-item-amount {
                font-size: 22px;
            }
            
            .transaction-item-details {
                font-size: 16px;
            }
        }
        
        .container {
            max-width: 98%;
            width: 100%;
            margin: 30px auto;
            padding: 0 12px;
        }
        @media (min-width: 1600px) {
            .container {
                max-width: 1600px;
                padding: 0 20px;
            }
        }
        
        /* ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1‚Äì3 ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏≠‡∏ö‡πÉ‡∏´‡πâ wrap ‡∏•‡∏á‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà */
        .steps-row {
            display: flex;
            flex-wrap: wrap;
            flex-direction: row;
            gap: 20px;
            margin-bottom: 20px;
        }
        .steps-row .card {
            flex: 1 1 320px;
            min-width: min(320px, 100%);
            margin-bottom: 0;
        }
        @media (max-width: 768px) {
            .steps-row .card {
                flex: 1 1 100%;
                min-width: 100%;
            }
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 32px;
            border-bottom: 3px solid #28a745;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #555;
            font-weight: bold;
            font-size: 22px;
        }
        
        .form-group input {
            width: 100%;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 8px;
            font-size: 24px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #28a745;
        }
        
        .btn {
            padding: 20px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            margin-bottom: 10px;
            min-height: 60px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .balance-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }
        
        .balance-display.show {
            display: block;
        }
        
        .balance-label {
            font-size: 24px;
            opacity: 0.9;
            margin-bottom: 15px;
        }
        
        .balance-amount {
            font-size: 64px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .balance-info {
            font-size: 20px;
            opacity: 0.9;
            line-height: 1.6;
        }
        
        .amount-input-group {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .amount-input-group input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 18px;
        }
        
        .quick-amount-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-amount-btn {
            padding: 18px;
            border: 3px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 60px;
        }
        
        .quick-amount-btn:hover {
            background: #f8f9fa;
            border-color: #28a745;
        }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
            font-size: 20px;
            font-weight: bold;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .transaction-history {
            margin-top: 30px;
        }
        
        .transaction-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
        
        .transaction-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .transaction-item-amount {
            font-size: 26px;
            font-weight: bold;
            color: #28a745;
        }
        
        .transaction-item-details {
            font-size: 18px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #28a745;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .qr-scanner-area {
            border: 2px dashed #28a745;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .qr-scanner-area p {
            color: #666;
            margin-bottom: 10px;
            font-size: 20px;
        }
        
        #qr-video {
            background: #000;
            border-radius: 8px;
        }
        
        #qr-scanner-container {
            text-align: center;
            margin: 15px 0;
        }
        
        /* Summary Popup Modal */
        .summary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .summary-modal.show {
            display: flex;
        }
        
        .summary-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .summary-modal-title {
            font-size: 32px;
            color: #28a745;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .summary-modal-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .summary-modal-label {
            font-size: 20px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .summary-modal-value {
            font-size: 36px;
            font-weight: bold;
            color: #333;
        }
        
        .summary-modal-amount {
            color: #28a745;
        }
        
        .summary-modal-balance {
            color: #007bff;
        }
        
        .summary-modal-footer {
            margin-top: 30px;
            font-size: 18px;
            color: #666;
        }
        
        /* Edit Quick Amount Modal */
        .edit-amount-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .edit-amount-modal.show {
            display: flex;
        }
        
        .edit-amount-modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .edit-amount-modal-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .edit-amount-input {
            width: 100%;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 10px;
            font-size: 32px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .edit-amount-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-amount-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .edit-amount-btn-cancel {
            background: #dc3545;
            color: white;
        }
        
        .edit-amount-btn-save {
            background: #28a745;
            color: white;
        }
        
        /* Numeric Keypad */
        .numeric-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
            transition: all 0.3s ease;
            overflow: hidden;
            max-height: 500px;
        }
        
        .numeric-keypad.hidden {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
            pointer-events: none;
        }
        
        .keypad-btn {
            padding: 25px;
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            font-size: 36px;
            font-weight: bold;
            transition: all 0.2s;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            min-height: 70px;
        }
        
        .keypad-btn:active {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(0.95);
        }
        
        .keypad-btn:hover {
            background: #f8f9fa;
            border-color: #28a745;
        }
        
        .keypad-btn.clear {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .keypad-btn.clear:active {
            background: #c82333;
        }
        
        .keypad-btn.enter {
            background: #28a745;
            color: white;
            border-color: #28a745;
            grid-column: span 2;
        }
        
        .keypad-btn.enter:active {
            background: #218838;
        }
        
        .keypad-btn.zero {
            grid-column: span 1;
        }
        
        /* Mobile Portrait - Adjust keypad but keep large */
        @media (max-width: 768px) and (orientation: portrait) {
            .numeric-keypad {
                gap: 10px;
                margin-top: 15px;
            }
            
            .keypad-btn {
                padding: 20px;
                font-size: 32px;
                min-height: 65px;
            }
            
            .summary-modal-content {
                padding: 30px;
            }
            
            .summary-modal-title {
                font-size: 28px;
            }
            
            .summary-modal-value {
                font-size: 32px;
            }
        }
        
        /* Tablet - Medium sizes */
        @media (min-width: 769px) and (max-width: 1024px) {
            body {
                font-size: 24px;
            }
            
            .store-header h1 {
                font-size: 24px;
            }
            
            .card h2 {
                font-size: 36px;
            }
            
            .form-group label {
                font-size: 24px;
            }
            
            .form-group input {
                font-size: 28px;
                padding: 22px;
            }
            
            #amount-input {
                font-size: 52px !important;
            }
            
            .btn {
                font-size: 26px;
                padding: 22px 30px;
                min-height: 70px;
            }
            
            .quick-amount-btn {
                font-size: 24px;
                padding: 20px;
                min-height: 65px;
            }
            
            .keypad-btn {
                font-size: 40px;
                padding: 28px;
                min-height: 80px;
            }
            
            .balance-amount {
                font-size: 72px;
            }
        }
        
        /* Large Desktop - Extra large for accessibility */
        @media (min-width: 1025px) {
            body {
                font-size: 24px;
            }
            
            .store-header h1 {
                font-size: 26px;
            }
            
            .card h2 {
                font-size: 38px;
            }
            
            .form-group label {
                font-size: 26px;
            }
            
            .form-group input {
                font-size: 30px;
                padding: 24px;
            }
            
            #amount-input {
                font-size: 56px !important;
            }
            
            .btn {
                font-size: 28px;
                padding: 24px 35px;
                min-height: 75px;
            }
            
            .quick-amount-btn {
                font-size: 26px;
                padding: 22px;
                min-height: 70px;
            }
            
            .keypad-btn {
                font-size: 44px;
                padding: 30px;
                min-height: 85px;
            }
            
            .balance-amount {
                font-size: 80px;
            }
        }
    </style>
    <!-- QR Code Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
</head>
<body>
    <div class="store-header">
        <h1>üè™ Store POS System</h1>
        <div class="store-info" id="store-info">
            <div class="store-info-item">
                <label>‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô</label>
                <div class="value" id="store-name">-</div>
            </div>
            <div class="store-info-item">
                <label>Store ID</label>
                <div class="value" id="store-id">-</div>
            </div>
            <div class="store-info-item">
                <label>Tax ID</label>
                <div class="value" id="store-tax-id">-</div>
            </div>
            <div class="store-info-item">
                <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                <div class="value" id="store-status">-</div>
            </div>
            <div class="store-info-item">
                <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                <div class="value" id="store-location">-</div>
            </div>
            <div class="store-info-item">
                <label>Profile</label>
                <div class="value" id="store-profile">-</div>
            </div>
            <div class="store-info-item">
                <label>Event</label>
                <div class="value" id="store-event">-</div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div id="alert-container"></div>
        
        <div class="steps-row">
        <div class="card">
            <h2>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å</h2>
            
            <div class="form-group">
                <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
                <input 
                    type="text" 
                    id="amount-input" 
                    placeholder="0.00"
                    autocomplete="off"
                    autofocus
                    readonly
                    style="text-align: center; font-size: 48px; font-weight: bold; background: #f8f9fa; cursor: pointer;"
                    onclick="showKeypadForEdit()"
                >
            </div>
            
            <div class="quick-amount-buttons" id="quick-amount-buttons">
                <!-- Quick amount buttons will be loaded from API -->
            </div>
            
            <!-- Numeric Keypad -->
            <div class="numeric-keypad" id="numeric-keypad">
                <button class="keypad-btn" onclick="keypadInput('1')">1</button>
                <button class="keypad-btn" onclick="keypadInput('2')">2</button>
                <button class="keypad-btn" onclick="keypadInput('3')">3</button>
                <button class="keypad-btn" onclick="keypadInput('4')">4</button>
                <button class="keypad-btn" onclick="keypadInput('5')">5</button>
                <button class="keypad-btn" onclick="keypadInput('6')">6</button>
                <button class="keypad-btn" onclick="keypadInput('7')">7</button>
                <button class="keypad-btn" onclick="keypadInput('8')">8</button>
                <button class="keypad-btn" onclick="keypadInput('9')">9</button>
                <button class="keypad-btn" onclick="keypadInput('.')">.</button>
                <button class="keypad-btn" onclick="keypadInput('0')">0</button>
                <button class="keypad-btn clear" onclick="clearAmount()">‡∏•‡∏ö</button>
                <button class="keypad-btn enter" onclick="confirmAmount()" style="grid-column: span 3; margin-top: 10px;">‚úì ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
        
        <div class="card">
            <h2>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PromptPay QR Code</h2>
            
            <div class="form-group">
                <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Menu)</label>
                <select id="menu-select" class="form-group input" style="padding: 20px; border: 3px solid #ddd; border-radius: 8px; font-size: 24px; width: 100%;">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Remark)</label>
                <input 
                    type="text" 
                    id="remark-input" 
                    placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                    autocomplete="off"
                    style="padding: 20px; border: 3px solid #ddd; border-radius: 8px; font-size: 24px; width: 100%;"
                >
            </div>
            
            <div class="form-group">
                <label>PromptPay Mobile (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Tag29 - Credit Transfer)</label>
                <input 
                    type="text" 
                    id="promptpay-mobile-input" 
                    placeholder="0812345678 (10 ‡∏´‡∏•‡∏±‡∏Å) - ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö"
                    autocomplete="off"
                    maxlength="10"
                    style="padding: 20px; border: 3px solid #ddd; border-radius: 8px; font-size: 24px; width: 100%;"
                >
                <small style="color: #666; font-size: 18px;">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÅ‡∏ö‡∏ö Tag29 (Credit Transfer)</small>
            </div>
            
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏° (Total Price) - ‡∏ö‡∏≤‡∏ó</label>
                <input 
                    type="text" 
                    id="total-price-input" 
                    placeholder="0.00"
                    autocomplete="off"
                    readonly
                    style="text-align: center; font-size: 48px; font-weight: bold; background: #f8f9fa; cursor: pointer; padding: 20px; border: 3px solid #ddd; border-radius: 8px;"
                    onclick="showKeypadForTotalPrice()"
                >
            </div>
            
            <button class="btn btn-primary" onclick="generatePromptPayQR()" id="generate-qr-btn" disabled>üì± ‡∏™‡∏£‡πâ‡∏≤‡∏á PromptPay QR Code</button>
            
            <div id="qr-code-display" style="display: none; margin-top: 20px;">
                <div id="qr-code-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Tag30 - Bill Payment (Static + Dynamic ‡∏à‡∏≤‡∏Å store.biller_id, store.token) -->
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 15px; font-size: 24px; color: #28a745;">Tag30 - Bill Payment</h3>
                        <p style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (biller_id + ref1 ‡∏à‡∏≤‡∏Å DB)</p>
                        <div style="margin-bottom: 20px;">
                            <p style="font-size: 16px; color: #555; margin-bottom: 8px;">Static - ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å)</p>
                            <img id="qr-code-image-tag30-static" src="" alt="PromptPay QR Tag30 Static" style="max-width: 100%; border: 2px solid #28a745; border-radius: 10px; padding: 10px; background: white;">
                        </div>
                        <div>
                            <p style="font-size: 16px; color: #555; margin-bottom: 8px;">Dynamic - ‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏™‡πÅ‡∏Å‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢)</p>
                            <img id="qr-code-image-tag30" src="" alt="PromptPay QR Code Tag30 Dynamic" style="max-width: 100%; border: 2px solid #1e7e34; border-radius: 10px; padding: 10px; background: white;">
                        </div>
                    </div>
                    
                    <!-- Tag29 - Credit Transfer -->
                    <div style="text-align: center;">
                        <h3 style="margin-bottom: 15px; font-size: 24px; color: #007bff;">Tag29 - Credit Transfer</h3>
                        <p style="font-size: 18px; color: #666; margin-bottom: 10px;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</p>
                        <div id="qr-code-tag29-container">
                            <img id="qr-code-image-tag29" src="" alt="PromptPay QR Code Tag29" style="max-width: 100%; border: 3px solid #007bff; border-radius: 10px; padding: 10px; background: white; display: none;">
                            <p id="qr-code-tag29-message" style="font-size: 18px; color: #999; padding: 20px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å PromptPay Mobile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code Tag29</p>
                        </div>
                    </div>
                </div>
                <p style="margin-top: 15px; font-size: 20px; color: #666; text-align: center;">‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
                <div style="margin-top: 20px; text-align: center;">
                    <button type="button" class="btn btn-secondary" onclick="cancelPayment()" style="background: #6c757d; color: #fff; border: none; padding: 14px 28px; font-size: 20px; border-radius: 8px; cursor: pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚Äì ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
                </div>
            </div>
            
            <style>
                /* Mobile responsive for QR Code display */
                @media (max-width: 768px) {
                    #qr-code-grid {
                        grid-template-columns: 1fr !important;
                        gap: 20px !important;
                    }
                    
                    #qr-code-display h3 {
                        font-size: 20px !important;
                    }
                    
                    #qr-code-display p {
                        font-size: 16px !important;
                    }
                }
            </style>
        </div>
        
        <div class="card">
            <h2>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å Food Court ID</h2>
            
            <div class="qr-scanner-area">
                <p>üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™ Food Court ID</p>
                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="startQRScanner()" id="start-scanner-btn" style="margin-bottom: 10px;">üì∑ ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR Code</button>
                    <button class="btn btn-primary" onclick="stopQRScanner()" id="stop-scanner-btn" style="display: none; margin-bottom: 10px;">‚èπÔ∏è ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                </div>
                <div id="qr-scanner-container" style="display: none; margin-bottom: 15px;">
                    <video id="qr-video" width="100%" style="border-radius: 8px; max-width: 400px;"></video>
                </div>
                <div class="form-group">
                    <input 
                        type="text" 
                        id="foodcourt-id-input" 
                        placeholder="FC-20241201-12345 ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô QR Code"
                        autocomplete="off"
                    >
                </div>
            </div>
            
            <button class="btn btn-success" onclick="processPayment()" id="process-payment-btn" disabled>üí≥ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button class="btn btn-danger" onclick="clearAll()" style="margin-top: 10px;">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        </div>
        <!-- end .steps-row -->
        
        <div class="balance-display" id="balance-display" style="display: none;">
            <div class="balance-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
            <div class="balance-amount" id="balance-amount">0.00</div>
            <div class="balance-info">
                <div>Food Court ID: <strong id="display-fc-id">-</strong></div>
                <div>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: <strong id="display-initial-amount">0.00</strong> ‡∏ö‡∏≤‡∏ó</div>
                <div>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô: <strong id="display-payment-method">-</strong></div>
            </div>
        </div>
        
        <div class="card transaction-history">
            <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h2>
            <div id="transaction-history-list">
                <p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
        </div>
    </div>
    
    <!-- Summary Modal -->
    <div class="summary-modal" id="summary-modal">
        <div class="summary-modal-content">
            <div class="summary-modal-title">‚úÖ ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
            <div class="summary-modal-item">
                <div class="summary-modal-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏Å</div>
                <div class="summary-modal-value summary-modal-amount" id="summary-amount">0.00 ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="summary-modal-item">
                <div class="summary-modal-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
                <div class="summary-modal-value summary-modal-balance" id="summary-balance">0.00 ‡∏ö‡∏≤‡∏ó</div>
            </div>
            <div class="summary-modal-item">
                <div class="summary-modal-label">Food Court ID</div>
                <div class="summary-modal-value" id="summary-fc-id" style="font-size: 24px;">-</div>
            </div>
            <div class="summary-modal-footer">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å...</div>
        </div>
    </div>
    
    <!-- Edit Quick Amount Modal -->
    <div class="edit-amount-modal" id="edit-amount-modal">
        <div class="edit-amount-modal-content">
            <div class="edit-amount-modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πà‡∏ß‡∏ô</div>
            <input 
                type="number" 
                id="edit-amount-input" 
                class="edit-amount-input" 
                min="0" 
                step="0.01" 
                placeholder="0.00"
            >
            <div class="edit-amount-buttons">
                <button class="edit-amount-btn edit-amount-btn-cancel" onclick="closeEditAmountModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="edit-amount-btn edit-amount-btn-save" onclick="saveQuickAmount()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE_URL = window.location.origin + '/api';
        (function tryFullscreen() {
            if (new URLSearchParams(window.location.search).get('fullscreen') !== '1') return;
            function goFullscreen() {
                var el = document.documentElement;
                if (el.requestFullscreen) el.requestFullscreen().catch(function() {});
                else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
                else if (el.msRequestFullscreen) el.msRequestFullscreen();
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', function() { setTimeout(goFullscreen, 300); });
            else setTimeout(goFullscreen, 300);
            document.addEventListener('click', function once() { goFullscreen(); document.removeEventListener('click', once); });
        })();
        let currentStoreId = null;
        let currentFoodCourtId = null;
        let currentBalance = 0;
        let transactionHistory = [];
        let qrScannerStream = null;
        let qrScannerInterval = null;
        let amountConfirmed = false;
        let quickAmounts = [];
        let editingQuickAmountId = null;
        let longPressTimer = null;
        let menus = [];
        let totalPriceConfirmed = false;
        let announcedPaidIds = new Set();
        let lastPaidPollTime = null;
        let recentPaidPollInterval = null;

        function speakPaymentReceived(amount) {
            if (!('speechSynthesis' in window)) return;
            const text = '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ' + (typeof amount === 'number' ? amount.toFixed(0) : amount) + ' ‡∏ö‡∏≤‡∏ó ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö';
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'th-TH';
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }

        async function pollRecentPaid() {
            if (!currentStoreId) return;
            try {
                const since = lastPaidPollTime ? lastPaidPollTime : new Date(Date.now() - 60000).toISOString().slice(0, 19);
                const res = await fetch(`${API_BASE_URL}/payment-callback/stores/${currentStoreId}/recent-paid?since=${encodeURIComponent(since)}`);
                if (!res.ok) return;
                const data = await res.json();
                const items = data.items || [];
                for (const item of items) {
                    if (announcedPaidIds.has(item.id)) continue;
                    announcedPaidIds.add(item.id);
                    showAlert('‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ' + parseFloat(item.amount).toFixed(2) + ' ‡∏ö‡∏≤‡∏ó', 'success');
                    speakPaymentReceived(item.amount);
                }
                if (items.length > 0 && items[0].paid_at) lastPaidPollTime = items[0].paid_at;
            } catch (e) { console.warn('pollRecentPaid', e); }
        }

        function startRecentPaidPolling() {
            if (recentPaidPollInterval) return;
            recentPaidPollInterval = setInterval(pollRecentPaid, 5000);
            pollRecentPaid();
        }

        // Load store info on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Get store ID from URL parameter or use default
            const urlParams = new URLSearchParams(window.location.search);
            const storeId = urlParams.get('store_id') || 1; // Default to store ID 1
            
            loadStoreInfo(storeId);
            loadQuickAmounts(storeId);
            loadMenus(storeId);
            startRecentPaidPolling();
            
            // Setup QR scanner button event listeners
            const startScannerBtn = document.getElementById('start-scanner-btn');
            const stopScannerBtn = document.getElementById('stop-scanner-btn');
            
            if (startScannerBtn) {
                startScannerBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Start scanner button clicked');
                    startQRScanner();
                });
            }
            
            if (stopScannerBtn) {
                stopScannerBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Stop scanner button clicked');
                    stopQRScanner();
                });
            }
            
            // Enable/disable process button based on inputs
            const amountInput = document.getElementById('amount-input');
            const fcIdInput = document.getElementById('foodcourt-id-input');
            const processBtn = document.getElementById('process-payment-btn');
            
            function checkInputs() {
                const amountValue = parseFloat(amountInput.value.replace(/[^\d.]/g, ''));
                const hasAmount = !isNaN(amountValue) && amountValue > 0 && amountConfirmed;
                const hasFcId = fcIdInput.value.trim().length > 0;
                const shouldEnable = hasAmount && hasFcId;
                processBtn.disabled = !shouldEnable;
            }
            
            // Make checkInputs available globally
            window.checkInputs = checkInputs;
            
            // Initial check
            checkInputs();
            
            amountInput.addEventListener('input', checkInputs);
            amountInput.addEventListener('change', checkInputs);
            fcIdInput.addEventListener('input', checkInputs);
            fcIdInput.addEventListener('change', checkInputs);
            
            // Allow Enter key to trigger process payment or confirm amount
            fcIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !processBtn.disabled) {
                    e.preventDefault();
                    processPayment();
                }
            });
            
            fcIdInput.addEventListener('keydown', function(e) {
                if (e.key === 'Tab' && fcIdInput.value.trim().length > 0 && !processBtn.disabled) {
                    // Auto process on Tab if FC ID is entered
                    e.preventDefault();
                    processPayment();
                }
            });
        });
        
        async function loadStoreInfo(storeId) {
            try {
                console.log('Loading store info for ID:', storeId);
                const response = await fetch(`${API_BASE_URL}/stores/${storeId}`);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const store = await response.json();
                console.log('Store data:', store);
                
                currentStoreId = store.id;
                
                document.getElementById('store-name').textContent = store.name || '-';
                document.getElementById('store-id').textContent = store.id;
                document.getElementById('store-tax-id').textContent = store.tax_id || '-';
                document.getElementById('store-status').textContent = store.crypto_enabled ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‚ùå ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
                document.getElementById('store-location').textContent = store.location_name || '-';
                document.getElementById('store-profile').textContent = store.profile_name || '-';
                document.getElementById('store-event').textContent = store.event_name || '-';
            } catch (error) {
                console.error('Error loading store info:', error);
                showAlert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ: ' + error.message, 'error');
            }
        }
        
        async function loadQuickAmounts(storeId) {
            try {
                const response = await fetch(`${API_BASE_URL}/stores/${storeId}/quick-amounts/`);
                
                if (!response.ok) {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ quick amounts ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
                    console.log('No quick amounts found, using defaults');
                    quickAmounts = [
                        { id: null, amount: 50, label: '50 ‡∏ö‡∏≤‡∏ó' },
                        { id: null, amount: 100, label: '100 ‡∏ö‡∏≤‡∏ó' },
                        { id: null, amount: 200, label: '200 ‡∏ö‡∏≤‡∏ó' },
                        { id: null, amount: 500, label: '500 ‡∏ö‡∏≤‡∏ó' }
                    ];
                    renderQuickAmountButtons();
                    return;
                }
                
                quickAmounts = await response.json();
                renderQuickAmountButtons();
            } catch (error) {
                console.error('Error loading quick amounts:', error);
                // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
                quickAmounts = [
                    { id: null, amount: 50, label: '50 ‡∏ö‡∏≤‡∏ó' },
                    { id: null, amount: 100, label: '100 ‡∏ö‡∏≤‡∏ó' },
                    { id: null, amount: 200, label: '200 ‡∏ö‡∏≤‡∏ó' },
                    { id: null, amount: 500, label: '500 ‡∏ö‡∏≤‡∏ó' }
                ];
                renderQuickAmountButtons();
            }
        }
        
        function renderQuickAmountButtons() {
            const container = document.getElementById('quick-amount-buttons');
            container.innerHTML = '';
            
            quickAmounts.forEach(qa => {
                const button = document.createElement('button');
                button.className = 'quick-amount-btn';
                button.textContent = qa.label || `${qa.amount} ‡∏ö‡∏≤‡∏ó`;
                button.dataset.amount = qa.amount;
                button.dataset.id = qa.id || '';
                
                // Click event - set amount
                button.addEventListener('click', function(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    } else {
                        setAmount(qa.amount);
                    }
                });
                
                // Long press event - edit amount
                button.addEventListener('mousedown', function(e) {
                    longPressTimer = setTimeout(() => {
                        openEditAmountModal(qa);
                        longPressTimer = null;
                    }, 500); // 500ms = long press
                });
                
                button.addEventListener('mouseup', function(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                button.addEventListener('mouseleave', function(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                // Touch events for mobile
                button.addEventListener('touchstart', function(e) {
                    longPressTimer = setTimeout(() => {
                        e.preventDefault();
                        openEditAmountModal(qa);
                        longPressTimer = null;
                    }, 500);
                });
                
                button.addEventListener('touchend', function(e) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                });
                
                container.appendChild(button);
            });
        }
        
        function openEditAmountModal(quickAmount) {
            editingQuickAmountId = quickAmount.id;
            const input = document.getElementById('edit-amount-input');
            input.value = quickAmount.amount;
            document.getElementById('edit-amount-modal').classList.add('show');
            setTimeout(() => input.focus(), 100);
        }
        
        function closeEditAmountModal() {
            document.getElementById('edit-amount-modal').classList.remove('show');
            editingQuickAmountId = null;
            document.getElementById('edit-amount-input').value = '';
        }
        
        async function saveQuickAmount() {
            const input = document.getElementById('edit-amount-input');
            const newAmount = parseFloat(input.value);
            
            if (!newAmount || newAmount <= 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                return;
            }
            
            try {
                if (editingQuickAmountId) {
                    // Update existing
                    const response = await fetch(`${API_BASE_URL}/stores/${currentStoreId}/quick-amounts/${editingQuickAmountId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: newAmount,
                            label: `${newAmount} ‡∏ö‡∏≤‡∏ó`
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏î‡πâ');
                    }
                } else {
                    // Create new
                    const response = await fetch(`${API_BASE_URL}/stores/${currentStoreId}/quick-amounts/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: newAmount,
                            label: `${newAmount} ‡∏ö‡∏≤‡∏ó`
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ');
                    }
                }
                
                // Reload quick amounts
                await loadQuickAmounts(currentStoreId);
                closeEditAmountModal();
                showAlert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏î‡πà‡∏ß‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('Error saving quick amount:', error);
                showAlert('‚ùå ' + error.message, 'error');
            }
        }
        
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }
        
        
        function setAmount(amount) {
            const amountInput = document.getElementById('amount-input');
            amountInput.value = amount.toFixed(2);
            // Trigger input and change events to enable/disable button
            const inputEvent = new Event('input', { bubbles: true });
            amountInput.dispatchEvent(inputEvent);
            const changeEvent = new Event('change', { bubbles: true });
            amountInput.dispatchEvent(changeEvent);
        }
        
        let activeInput = 'amount-input'; // Track which input is active
        
        function keypadInput(digit) {
            // Determine which input to use
            let targetInput;
            if (activeInput === 'total-price-input') {
                targetInput = document.getElementById('total-price-input');
            } else {
                targetInput = document.getElementById('amount-input');
            }
            
            let currentValue = targetInput.value || '';
            
            // Remove formatting and get clean number
            currentValue = currentValue.replace(/[^\d.]/g, '');
            
            // Handle decimal point
            if (digit === '.') {
                if (!currentValue.includes('.')) {
                    if (currentValue === '') {
                        currentValue = '0.';
                    } else {
                        currentValue += '.';
                    }
                }
            } else {
                // Handle number input
                if (currentValue === '0' || currentValue === '') {
                    currentValue = digit;
                } else {
                    // Check if we already have 2 decimal places
                    if (currentValue.includes('.')) {
                        const parts = currentValue.split('.');
                        if (parts[1] && parts[1].length >= 2) {
                            return; // Don't add more than 2 decimal places
                        }
                    }
                    currentValue += digit;
                }
            }
            
            // Format and set value
            targetInput.value = currentValue;
            
            // Trigger input and change events to enable/disable button
            const inputEvent = new Event('input', { bubbles: true });
            targetInput.dispatchEvent(inputEvent);
            const changeEvent = new Event('change', { bubbles: true });
            targetInput.dispatchEvent(changeEvent);
        }
        
        function confirmAmount() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value.replace(/[^\d.]/g, ''));
            
            if (!amount || amount <= 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å', 'error');
                return;
            }
            
            // Hide keypad
            const keypad = document.getElementById('numeric-keypad');
            keypad.classList.add('hidden');
            amountConfirmed = true;
            
            // Update button state
            checkInputs();
            
            // Focus on Food Court ID input
            const fcIdInput = document.getElementById('foodcourt-id-input');
            setTimeout(() => {
                fcIdInput.focus();
            }, 100);
        }
        
        // Add event listener for total price input
        document.addEventListener('DOMContentLoaded', function() {
            const totalPriceInput = document.getElementById('total-price-input');
            if (totalPriceInput) {
                totalPriceInput.addEventListener('input', function() {
                    updateGenerateQRButtonState();
                });
                totalPriceInput.addEventListener('change', function() {
                    const value = parseFloat(this.value.replace(/[^\d.]/g, ''));
                    if (value > 0) {
                        totalPriceConfirmed = true;
                        updateGenerateQRButtonState();
                    }
                });
            }
            
            // Add event listener for menu select
            const menuSelect = document.getElementById('menu-select');
            if (menuSelect) {
                menuSelect.addEventListener('change', function() {
                    // Auto-fill total price if menu is selected
                    const selectedMenu = menus.find(m => m.id === parseInt(this.value));
                    if (selectedMenu) {
                        document.getElementById('total-price-input').value = selectedMenu.unit_price.toFixed(2);
                        totalPriceConfirmed = true;
                        updateGenerateQRButtonState();
                    }
                });
            }
        });
        
        function showKeypadForEdit() {
            // Show keypad again for editing amount
            activeInput = 'amount-input';
            const keypad = document.getElementById('numeric-keypad');
            keypad.classList.remove('hidden');
            amountConfirmed = false;
            
            // Update button state
            checkInputs();
        }
        
        function showKeypadForTotalPrice() {
            // Show keypad for total price
            activeInput = 'total-price-input';
            const keypad = document.getElementById('numeric-keypad');
            keypad.classList.remove('hidden');
            totalPriceConfirmed = false;
            
            // Update button state
            updateGenerateQRButtonState();
        }
        
        function clearAmount() {
            // Determine which input to clear
            let targetInput;
            if (activeInput === 'total-price-input') {
                targetInput = document.getElementById('total-price-input');
            } else {
                targetInput = document.getElementById('amount-input');
            }
            
            const currentValue = targetInput.value || '';
            
            if (currentValue.length > 0) {
                // Remove last character
                targetInput.value = currentValue.slice(0, -1);
                
                // If empty, set to empty
                if (targetInput.value === '' || targetInput.value === '.') {
                    targetInput.value = '';
                }
                
                // Trigger input and change events
                const inputEvent = new Event('input', { bubbles: true });
                targetInput.dispatchEvent(inputEvent);
                const changeEvent = new Event('change', { bubbles: true });
                targetInput.dispatchEvent(changeEvent);
            }
        }
        
        function showSummaryModal(amount, balance, fcId) {
            const modal = document.getElementById('summary-modal');
            document.getElementById('summary-amount').textContent = 
                amount.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('summary-balance').textContent = 
                balance.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' ‡∏ö‡∏≤‡∏ó';
            document.getElementById('summary-fc-id').textContent = fcId;
            
            modal.classList.add('show');
            
            // Auto hide after 3 seconds and reset
            setTimeout(() => {
                modal.classList.remove('show');
                resetToFirstStep();
            }, 3000);
        }
        
        function resetToFirstStep() {
            // Clear all inputs
            document.getElementById('amount-input').value = '';
            document.getElementById('foodcourt-id-input').value = '';
            document.getElementById('balance-display').style.display = 'none';
            document.getElementById('process-payment-btn').disabled = true;
            amountConfirmed = false;
            
            // Show keypad again
            const keypad = document.getElementById('numeric-keypad');
            keypad.classList.remove('hidden');
            
            // Update button state
            checkInputs();
            
            // Focus on amount input
            setTimeout(() => {
                document.getElementById('amount-input').focus();
            }, 100);
            
            // Clear alert
            document.getElementById('alert-container').innerHTML = '';
        }
        
        async function processPayment() {
            const amountInput = document.getElementById('amount-input');
            const amount = parseFloat(amountInput.value.replace(/[^\d.]/g, ''));
            const fcId = document.getElementById('foodcourt-id-input').value.trim();
            
            if (!amount || amount <= 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å', 'error');
                return;
            }
            
            if (!fcId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô Food Court ID', 'error');
                return;
            }
            
            if (!currentStoreId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                // Step 1: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                const balanceResponse = await fetch(`${API_BASE_URL}/counter/balance/${fcId}`);
                
                if (!balanceResponse.ok) {
                    const error = await balanceResponse.json();
                    throw new Error(error.detail || '‡πÑ‡∏°‡πà‡∏û‡∏ö Food Court ID');
                }
                
                const balanceData = await balanceResponse.json();
                const currentBalance = parseFloat(balanceData.current_balance);
                
                // Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (currentBalance < amount) {
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                    document.getElementById('balance-amount').textContent = 
                        currentBalance.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    document.getElementById('display-fc-id').textContent = balanceData.foodcourt_id;
                    document.getElementById('display-initial-amount').textContent = 
                        parseFloat(balanceData.initial_amount).toLocaleString('th-TH', {minimumFractionDigits: 2});
                    document.getElementById('display-payment-method').textContent = balanceData.payment_method;
                    document.getElementById('balance-display').style.display = 'block';
                    
                    showAlert(`‚ùå ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏û‡∏≠! ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${currentBalance.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: ${amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó`, 'error');
                    showLoading(false);
                    return;
                }
                
                // Step 3: ‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô (‡∏ñ‡πâ‡∏≤‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏û‡∏≠)
                const useResponse = await fetch(`${API_BASE_URL}/payment-hub/use`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        foodcourt_id: fcId,
                        store_id: currentStoreId,
                        amount: amount
                    })
                });
                
                if (!useResponse.ok) {
                    const error = await useResponse.json();
                    throw new Error(error.detail || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô');
                }
                
                const useData = await useResponse.json();
                const remainingBalance = parseFloat(useData.remaining_balance);
                
                // Add to transaction history
                const transaction = {
                    id: Date.now(),
                    foodcourt_id: fcId,
                    amount: amount,
                    remaining_balance: remainingBalance,
                    timestamp: new Date().toLocaleString('th-TH')
                };
                transactionHistory.unshift(transaction);
                updateTransactionHistory();
                
                // Show summary modal
                showSummaryModal(amount, remainingBalance, fcId);
                
            } catch (error) {
                showAlert('‚ùå ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        function updateTransactionHistory() {
            const historyList = document.getElementById('transaction-history-list');
            
            if (transactionHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
                return;
            }
            
            let html = '';
            transactionHistory.forEach(trans => {
                html += `
                    <div class="transaction-item">
                        <div class="transaction-item-header">
                            <div>
                                <strong>${trans.foodcourt_id}</strong>
                                <div class="transaction-item-details">${trans.timestamp}</div>
                            </div>
                            <div class="transaction-item-amount">-${trans.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</div>
                        </div>
                        <div class="transaction-item-details">
                            ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${trans.remaining_balance.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó
                        </div>
                    </div>
                `;
            });
            
            historyList.innerHTML = html;
        }
        
        function clearAll() {
            stopQRScanner();
            document.getElementById('amount-input').value = '';
            document.getElementById('foodcourt-id-input').value = '';
            document.getElementById('remark-input').value = '';
            document.getElementById('total-price-input').value = '';
            document.getElementById('menu-select').value = '';
            document.getElementById('qr-code-display').style.display = 'none';
            document.getElementById('balance-display').style.display = 'none';
            document.getElementById('process-payment-btn').disabled = true;
            document.getElementById('generate-qr-btn').disabled = true;
            amountConfirmed = false;
            totalPriceConfirmed = false;
            
            // Show keypad again
            const keypad = document.getElementById('numeric-keypad');
            keypad.classList.remove('hidden');
            
            // Update button state
            checkInputs();
            
            // Focus on amount input
            setTimeout(() => {
                document.getElementById('amount-input').focus();
            }, 100);
            
            showAlert('‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'info');
        }
        
        async function loadMenus(storeId) {
            try {
                const response = await fetch(`${API_BASE_URL}/menus/store/${storeId}`);
                
                if (!response.ok) {
                    console.log('No menus found or error loading menus');
                    menus = [];
                    return;
                }
                
                menus = await response.json();
                renderMenuSelect();
            } catch (error) {
                console.error('Error loading menus:', error);
                menus = [];
            }
        }
        
        function renderMenuSelect() {
            const select = document.getElementById('menu-select');
            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
            
            menus.forEach(menu => {
                if (menu.is_active) {
                    const option = document.createElement('option');
                    option.value = menu.id;
                    option.textContent = `${menu.name} - ${menu.unit_price.toFixed(2)} ‡∏ö‡∏≤‡∏ó`;
                    select.appendChild(option);
                }
            });
            
            // Update generate QR button state
            updateGenerateQRButtonState();
        }
        
        function updateGenerateQRButtonState() {
            const totalPriceInput = document.getElementById('total-price-input');
            const totalPrice = parseFloat(totalPriceInput.value.replace(/[^\d.]/g, ''));
            const hasTotalPrice = !isNaN(totalPrice) && totalPrice > 0 && totalPriceConfirmed;
            
            const generateBtn = document.getElementById('generate-qr-btn');
            generateBtn.disabled = !hasTotalPrice;
        }
        
        
        async function generatePromptPayQR() {
            const totalPriceInput = document.getElementById('total-price-input');
            const totalPrice = parseFloat(totalPriceInput.value.replace(/[^\d.]/g, ''));
            const menuSelect = document.getElementById('menu-select');
            const menuId = menuSelect.value ? parseInt(menuSelect.value) : null;
            const remarkInput = document.getElementById('remark-input');
            const remark = remarkInput.value.trim() || null;
            const promptpayMobileInput = document.getElementById('promptpay-mobile-input');
            const promptpayMobile = promptpayMobileInput.value.trim() || null;
            
            if (!totalPrice || totalPrice <= 0) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°', 'error');
                return;
            }
            
            if (!currentStoreId) {
                showAlert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const requestBody = {
                    menu_id: menuId,
                    ref3: remark,
                    amount: totalPrice
                };
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° promptpay_mobile ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (promptpayMobile) {
                    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡πÄ‡∏≠‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
                    const mobileClean = promptpayMobile.replace(/\D/g, '');
                    if (mobileClean.length === 10) {
                        requestBody.promptpay_mobile = mobileClean;
                    } else if (mobileClean.length > 0) {
                        showAlert('‚ö†Ô∏è ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏´‡∏•‡∏±‡∏Å', 'error');
                        showLoading(false);
                        return;
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/stores/${currentStoreId}/generate-promptpay-qr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code ‡πÑ‡∏î‡πâ');
                }
                
                const data = await response.json();
                
                // ‡πÅ‡∏™‡∏î‡∏á QR Code Tag30 Static (‡πÑ‡∏°‡πà‡∏°‡∏µ amount - ‡∏à‡∏≤‡∏Å store.biller_id, store.token)
                if (data.qr_code_tag30_static) {
                    document.getElementById('qr-code-image-tag30-static').src = data.qr_code_tag30_static;
                }
                // ‡πÅ‡∏™‡∏î‡∏á QR Code Tag30 Dynamic (‡∏°‡∏µ amount)
                document.getElementById('qr-code-image-tag30').src = data.qr_code_tag30;
                
                // ‡πÅ‡∏™‡∏î‡∏á QR Code Tag29 (Credit Transfer) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                if (data.qr_code_tag29) {
                    document.getElementById('qr-code-image-tag29').src = data.qr_code_tag29;
                    document.getElementById('qr-code-image-tag29').style.display = 'block';
                    document.getElementById('qr-code-tag29-message').style.display = 'none';
                } else {
                    document.getElementById('qr-code-image-tag29').style.display = 'none';
                    document.getElementById('qr-code-tag29-message').style.display = 'block';
                    document.getElementById('qr-code-tag29-message').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å PromptPay Mobile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á QR Code Tag29';
                }
                
                document.getElementById('qr-code-display').style.display = 'block';

                // ‡∏™‡πà‡∏á QR ‡πÑ‡∏õ‡∏à‡∏≠‡∏ó‡∏µ‡πà 2 (Signage) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                try {
                    await fetch(`${API_BASE_URL}/signage/set-display`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            store_id: currentStoreId,
                            qr_image: data.qr_code_tag30,
                            amount: totalPrice
                        })
                    });
                } catch (e) { console.warn('Signage set-display', e); }
                
                showAlert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á PromptPay QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
                
            } catch (error) {
                showAlert('‚ùå ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        /** ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢ ‚Äì ‡∏ã‡πà‡∏≠‡∏ô QR, ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2, ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≠ signage ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ */
        function cancelPayment() {
            document.getElementById('qr-code-display').style.display = 'none';
            document.getElementById('total-price-input').value = '';
            document.getElementById('menu-select').value = '';
            document.getElementById('remark-input').value = '';
            document.getElementById('promptpay-mobile-input').value = '';
            document.getElementById('generate-qr-btn').disabled = true;
            totalPriceConfirmed = false;
            updateGenerateQRButtonState();
            if (currentStoreId) {
                fetch(`${API_BASE_URL}/signage/clear?store_id=${currentStoreId}`, { method: 'POST' }).catch(function() {});
            }
            showAlert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ', 'info');
        }
        
        // QR Code Scanner Functions
        async function startQRScanner() {
            console.log('startQRScanner() called');
            
            try {
                // Check if jsQR is loaded
                if (typeof jsQR === 'undefined') {
                    console.error('jsQR library not loaded');
                    showAlert('‚ùå QR Code library ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö', 'error');
                    return;
                }
                console.log('jsQR library loaded');
                
                // Check if getUserMedia is available
                if (!navigator.mediaDevices) {
                    console.error('navigator.mediaDevices not available');
                    showAlert('‚ùå Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost', 'error');
                    return;
                }
                
                if (!navigator.mediaDevices.getUserMedia) {
                    console.error('getUserMedia not available');
                    // Try legacy API
                    navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia ||
                        navigator.webkitGetUserMedia ||
                        navigator.mozGetUserMedia ||
                        navigator.msGetUserMedia;
                    
                    if (!navigator.mediaDevices.getUserMedia) {
                        showAlert('‚ùå Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ HTTPS ‡∏´‡∏£‡∏∑‡∏≠ localhost', 'error');
                        return;
                    }
                }
                console.log('getUserMedia available');
                
                const video = document.getElementById('qr-video');
                const container = document.getElementById('qr-scanner-container');
                const startBtn = document.getElementById('start-scanner-btn');
                const stopBtn = document.getElementById('stop-scanner-btn');
                
                if (!video || !container || !startBtn || !stopBtn) {
                    console.error('Required elements not found');
                    showAlert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö elements ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô', 'error');
                    return;
                }
                
                console.log('Requesting camera access...');
                
                // Request camera access
                let constraints = {
                    video: {
                        facingMode: 'environment' // Use back camera on mobile
                    }
                };
                
                let stream = null;
                
                // Fallback for devices that don't support facingMode
                try {
                    console.log('Trying with facingMode: environment');
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    qrScannerStream = stream;
                    console.log('Camera access granted with facingMode');
                } catch (e) {
                    // Try without facingMode constraint
                    console.log('Trying without facingMode constraint...', e);
                    try {
                        constraints = { video: true };
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                        qrScannerStream = stream;
                        console.log('Camera access granted without facingMode');
                    } catch (e2) {
                        console.error('Failed to get camera access:', e2);
                        throw e2;
                    }
                }
                
                console.log('Setting video source...');
                video.srcObject = qrScannerStream;
                
                // Wait for video to be ready
                video.onloadedmetadata = () => {
                    console.log('Video metadata loaded, playing...');
                    video.play().then(() => {
                        console.log('Video playing successfully');
                    }).catch(err => {
                        console.error('Error playing video:', err);
                        showAlert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠‡πÑ‡∏î‡πâ: ' + err.message, 'error');
                    });
                };
                
                video.onerror = (err) => {
                    console.error('Video error:', err);
                    showAlert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠', 'error');
                };
                
                console.log('Showing scanner container...');
                container.style.display = 'block';
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                
                // Create canvas for QR code detection
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                // Start scanning
                console.log('Starting QR code scanning...');
                qrScannerInterval = setInterval(() => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0 && video.videoHeight > 0) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        if (code) {
                            // Found QR code
                            console.log('QR code detected:', code.data);
                            const fcId = code.data.trim();
                            document.getElementById('foodcourt-id-input').value = fcId;
                            
                            // Trigger input event to enable button
                            const event = new Event('input', { bubbles: true });
                            document.getElementById('foodcourt-id-input').dispatchEvent(event);
                            
                            // Stop scanner
                            stopQRScanner();
                            
                            showAlert('‚úÖ ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + fcId, 'success');
                        }
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error starting QR scanner:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                let errorMessage = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ: ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö browser settings)';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏≠‡∏∑‡πà‡∏ô';
                } else if (error.name === 'OverconstrainedError' || error.name === 'ConstraintNotSatisfiedError') {
                    errorMessage += '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£';
                } else if (error.name === 'TypeError') {
                    errorMessage += 'Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ HTTPS)';
                } else {
                    errorMessage += error.message || error.toString();
                }
                
                showAlert(errorMessage, 'error');
                
                // Reset UI
                const container = document.getElementById('qr-scanner-container');
                const startBtn = document.getElementById('start-scanner-btn');
                const stopBtn = document.getElementById('stop-scanner-btn');
                if (container) container.style.display = 'none';
                if (startBtn) startBtn.style.display = 'block';
                if (stopBtn) stopBtn.style.display = 'none';
            }
        }
        
        function stopQRScanner() {
            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }
            
            if (qrScannerInterval) {
                clearInterval(qrScannerInterval);
                qrScannerInterval = null;
            }
            
            const video = document.getElementById('qr-video');
            if (video) {
                video.srcObject = null;
            }
            
            const container = document.getElementById('qr-scanner-container');
            const startBtn = document.getElementById('start-scanner-btn');
            const stopBtn = document.getElementById('stop-scanner-btn');
            
            if (container) container.style.display = 'none';
            if (startBtn) startBtn.style.display = 'block';
            if (stopBtn) stopBtn.style.display = 'none';
        }
    </script>
</body>
</html>


